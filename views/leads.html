<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BPO CRM - Leads</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar p-0">
        <div class="d-flex flex-column p-3">
          <a href="/dashboard" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            <span class="fs-4">BPO CRM</span>
          </a>
          <hr>
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <a href="/dashboard" class="nav-link text-white">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
              </a>
            </li>
            <li>
              <a href="/customers" class="nav-link text-white">
                <i class="bi bi-people me-2"></i>Customers
              </a>
            </li>
            <li>
              <a href="/leads" class="nav-link active">
                <i class="bi bi-person-plus me-2"></i>Leads
              </a>
            </li>
            <li>
              <a href="/tasks" class="nav-link text-white">
                <i class="bi bi-list-check me-2"></i>Tasks
              </a>
            </li>
            <li>
              <a href="/reports" class="nav-link text-white">
                <i class="bi bi-bar-chart me-2"></i>Reports
              </a>
            </li>
          </ul>
          <hr>
          <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="https://via.placeholder.com/32" alt="User" width="32" height="32" class="rounded-circle me-2">
              <strong>Admin</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
              <li><a class="dropdown-item" href="#">Settings</a></li>
              <li><a class="dropdown-item" href="#">Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/">Sign out</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Main content -->
      <div class="col-md-10 ms-sm-auto main-content">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Leads</h1>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeadModal">
            <i class="bi bi-plus-circle me-1"></i> Add Lead
          </button>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchLead" placeholder="Search leads...">
              <button class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="statusFilter">
              <option value="">All Statuses</option>
              <option value="New">New</option>
              <option value="Contacted">Contacted</option>
              <option value="Qualified">Qualified</option>
              <option value="Proposal">Proposal</option>
              <option value="Negotiation">Negotiation</option>
              <option value="Closed">Closed</option>
              <option value="Lost">Lost</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="sourceFilter">
              <option value="">All Sources</option>
              <option value="Website">Website</option>
              <option value="Referral">Referral</option>
              <option value="Cold Call">Cold Call</option>
              <option value="Social Media">Social Media</option>
              <option value="Email Campaign">Email Campaign</option>
              <option value="Trade Show">Trade Show</option>
              <option value="Partner">Partner</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="serviceFilter">
              <option value="">All Services</option>
              <option value="Customer Support">Customer Support</option>
              <option value="Back Office">Back Office</option>
              <option value="IT Services">IT Services</option>
              <option value="Human Resources">Human Resources</option>
              <option value="Finance & Accounting">Finance & Accounting</option>
              <option value="Healthcare">Healthcare</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="qualityFilter">
              <option value="">All Quality</option>
              <option value="Hot">Hot</option>
              <option value="Warm">Warm</option>
              <option value="Cold">Cold</option>
            </select>
          </div>
        </div>

        <!-- Leads Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Company</th>
                    <th>Contact</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Service Interest</th>
                    <th>Quality</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="leadsTable">
                  <!-- Leads will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Lead Modal -->
  <div class="modal fade" id="addLeadModal" tabindex="-1" aria-labelledby="addLeadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addLeadModalLabel">Add New Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addLeadForm">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3">Basic Information</h6>
                <div class="mb-3">
                  <label for="leadCompany" class="form-label">Company Name*</label>
                  <input type="text" class="form-control" id="leadCompany" required>
                </div>
                <div class="mb-3">
                  <label for="leadContact" class="form-label">Contact Person*</label>
                  <input type="text" class="form-control" id="leadContact" required>
                </div>
                <div class="mb-3">
                  <label for="leadEmail" class="form-label">Email*</label>
                  <input type="email" class="form-control" id="leadEmail" required>
                </div>
                <div class="mb-3">
                  <label for="leadPhone" class="form-label">Phone*</label>
                  <input type="text" class="form-control" id="leadPhone" required>
                </div>
                <div class="mb-3">
                  <label for="leadStatus" class="form-label">Status</label>
                  <select class="form-select" id="leadStatus">
                    <option value="New" selected>New</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Qualified">Qualified</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Negotiation">Negotiation</option>
                    <option value="Closed">Closed</option>
                    <option value="Lost">Lost</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="leadSource" class="form-label">Source</label>
                  <select class="form-select" id="leadSource">
                    <option value="Website" selected>Website</option>
                    <option value="Referral">Referral</option>
                    <option value="Cold Call">Cold Call</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Email Campaign">Email Campaign</option>
                    <option value="Trade Show">Trade Show</option>
                    <option value="Partner">Partner</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">BPO Qualification</h6>
                <div class="mb-3">
                  <label for="leadIndustry" class="form-label">Industry</label>
                  <select class="form-select" id="leadIndustry">
                    <option value="" selected>Select Industry</option>
                    <!-- Industry options will be loaded here -->
                  </select>
                </div>
                <div class="mb-3">
                  <label for="leadCompanySize" class="form-label">Company Size</label>
                  <select class="form-select" id="leadCompanySize">
                    <option value="">Select Company Size</option>
                    <option value="1-10">1-10 employees</option>
                    <option value="11-50">11-50 employees</option>
                    <option value="51-200">51-200 employees</option>
                    <option value="201-500">201-500 employees</option>
                    <option value="501-1000">501-1000 employees</option>
                    <option value="1001+">1001+ employees</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="leadBudget" class="form-label">Budget Range</label>
                  <select class="form-select" id="leadBudget">
                    <option value="">Select Budget Range</option>
                    <option value="Under $5,000">Under $5,000</option>
                    <option value="$5,000 - $10,000">$5,000 - $10,000</option>
                    <option value="$10,000 - $25,000">$10,000 - $25,000</option>
                    <option value="$25,000 - $50,000">$25,000 - $50,000</option>
                    <option value="$50,000 - $100,000">$50,000 - $100,000</option>
                    <option value="$100,000+">$100,000+</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="leadTimeline" class="form-label">Timeline</label>
                  <select class="form-select" id="leadTimeline">
                    <option value="">Select Timeline</option>
                    <option value="Immediate">Immediate</option>
                    <option value="1-3 months">1-3 months</option>
                    <option value="3-6 months">3-6 months</option>
                    <option value="6-12 months">6-12 months</option>
                    <option value="12+ months">12+ months</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="leadServiceInterest" class="form-label">Service Interest</label>
                  <select class="form-select" id="leadServiceInterest" multiple size="4">
                    <!-- Service options will be loaded here -->
                  </select>
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="leadDecisionMaker">
                  <label class="form-check-label" for="leadDecisionMaker">Contact is Decision Maker</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="leadPainPoints" class="form-label">Pain Points/Challenges</label>
              <textarea class="form-control" id="leadPainPoints" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="leadRequirements" class="form-label">Requirements/Expectations</label>
              <textarea class="form-control" id="leadRequirements" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="leadNotes" class="form-label">Additional Notes</label>
              <textarea class="form-control" id="leadNotes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveLeadBtn">Save Lead</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Lead Modal -->
  <div class="modal fade" id="editLeadModal" tabindex="-1" aria-labelledby="editLeadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editLeadModalLabel">Edit Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLeadForm">
            <input type="hidden" id="editLeadId">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3">Basic Information</h6>
                <div class="mb-3">
                  <label for="editLeadCompany" class="form-label">Company Name*</label>
                  <input type="text" class="form-control" id="editLeadCompany" required>
                </div>
                <div class="mb-3">
                  <label for="editLeadContact" class="form-label">Contact Person*</label>
                  <input type="text" class="form-control" id="editLeadContact" required>
                </div>
                <div class="mb-3">
                  <label for="editLeadEmail" class="form-label">Email*</label>
                  <input type="email" class="form-control" id="editLeadEmail" required>
                </div>
                <div class="mb-3">
                  <label for="editLeadPhone" class="form-label">Phone*</label>
                  <input type="text" class="form-control" id="editLeadPhone" required>
                </div>
                <div class="mb-3">
                  <label for="editLeadStatus" class="form-label">Status</label>
                  <select class="form-select" id="editLeadStatus">
                    <option value="New">New</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Qualified">Qualified</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Negotiation">Negotiation</option>
                    <option value="Closed">Closed</option>
                    <option value="Lost">Lost</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editLeadSource" class="form-label">Source</label>
                  <select class="form-select" id="editLeadSource">
                    <option value="Website">Website</option>
                    <option value="Referral">Referral</option>
                    <option value="Cold Call">Cold Call</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Email Campaign">Email Campaign</option>
                    <option value="Trade Show">Trade Show</option>
                    <option value="Partner">Partner</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3">BPO Qualification</h6>
                <div class="mb-3">
                  <label for="editLeadIndustry" class="form-label">Industry</label>
                  <select class="form-select" id="editLeadIndustry">
                    <option value="">Select Industry</option>
                    <!-- Industry options will be loaded here -->
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editLeadCompanySize" class="form-label">Company Size</label>
                  <select class="form-select" id="editLeadCompanySize">
                    <option value="">Select Company Size</option>
                    <option value="1-10">1-10 employees</option>
                    <option value="11-50">11-50 employees</option>
                    <option value="51-200">51-200 employees</option>
                    <option value="201-500">201-500 employees</option>
                    <option value="501-1000">501-1000 employees</option>
                    <option value="1001+">1001+ employees</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editLeadBudget" class="form-label">Budget Range</label>
                  <select class="form-select" id="editLeadBudget">
                    <option value="">Select Budget Range</option>
                    <option value="Under $5,000">Under $5,000</option>
                    <option value="$5,000 - $10,000">$5,000 - $10,000</option>
                    <option value="$10,000 - $25,000">$10,000 - $25,000</option>
                    <option value="$25,000 - $50,000">$25,000 - $50,000</option>
                    <option value="$50,000 - $100,000">$50,000 - $100,000</option>
                    <option value="$100,000+">$100,000+</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editLeadTimeline" class="form-label">Timeline</label>
                  <select class="form-select" id="editLeadTimeline">
                    <option value="">Select Timeline</option>
                    <option value="Immediate">Immediate</option>
                    <option value="1-3 months">1-3 months</option>
                    <option value="3-6 months">3-6 months</option>
                    <option value="6-12 months">6-12 months</option>
                    <option value="12+ months">12+ months</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editLeadServiceInterest" class="form-label">Service Interest</label>
                  <select class="form-select" id="editLeadServiceInterest" multiple size="4">
                    <!-- Service options will be loaded here -->
                  </select>
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="editLeadDecisionMaker">
                  <label class="form-check-label" for="editLeadDecisionMaker">Contact is Decision Maker</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="editLeadPainPoints" class="form-label">Pain Points/Challenges</label>
              <textarea class="form-control" id="editLeadPainPoints" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="editLeadRequirements" class="form-label">Requirements/Expectations</label>
              <textarea class="form-control" id="editLeadRequirements" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="editLeadNotes" class="form-label">Additional Notes</label>
              <textarea class="form-control" id="editLeadNotes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updateLeadBtn">Update Lead</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead Details Modal with Communication Tools -->
  <div class="modal fade" id="leadDetailsModal" tabindex="-1" aria-labelledby="leadDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="leadDetailsModalLabel">Lead Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span>Company Information</span>
                  <div>
                    <span class="badge rounded-pill bg-info" id="detailLeadQuality">Quality</span>
                    <span class="badge rounded-pill" id="detailLeadStatus">Status</span>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Company:</strong> <span id="detailLeadCompany"></span></p>
                      <p><strong>Contact:</strong> <span id="detailLeadContact"></span></p>
                      <p><strong>Email:</strong> <span id="detailLeadEmail"></span></p>
                      <p><strong>Phone:</strong> <span id="detailLeadPhone"></span></p>
                      <p><strong>Industry:</strong> <span id="detailLeadIndustry"></span></p>
                      <p><strong>Company Size:</strong> <span id="detailLeadCompanySize"></span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Source:</strong> <span id="detailLeadSource"></span></p>
                      <p><strong>Decision Maker:</strong> <span id="detailLeadDecisionMaker"></span></p>
                      <p><strong>Budget:</strong> <span id="detailLeadBudget"></span></p>
                      <p><strong>Timeline:</strong> <span id="detailLeadTimeline"></span></p>
                      <p><strong>Created:</strong> <span id="detailLeadCreated"></span></p>
                      <p><strong>Last Activity:</strong> <span id="detailLeadLastActivity"></span></p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="card mb-3">
                <div class="card-header">
                  <span>Service Interest</span>
                </div>
                <div class="card-body">
                  <p id="detailLeadServiceInterest"></p>
                </div>
              </div>
              
              <div class="card mb-3">
                <div class="card-header">
                  <span>Pain Points & Requirements</span>
                </div>
                <div class="card-body">
                  <p><strong>Pain Points:</strong> <span id="detailLeadPainPoints"></span></p>
                  <p><strong>Requirements:</strong> <span id="detailLeadRequirements"></span></p>
                  <p><strong>Notes:</strong> <span id="detailLeadNotes"></span></p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card mb-3">
                <div class="card-header">
                  <span>Lead Score</span>
                </div>
                <div class="card-body text-center">
                  <div class="progress mb-3">
                    <div class="progress-bar" id="detailLeadScoreBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                  </div>
                  <span class="fs-1 d-block" id="detailLeadScoreValue">0</span>
                  <span class="text-muted">out of 100</span>
                </div>
              </div>
              
              <div class="card mb-3">
                <div class="card-header">
                  <span>Actions</span>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="sendEmailBtn">
                      <i class="bi bi-envelope me-2"></i>Send Email
                    </button>
                    <button class="btn btn-outline-success" id="logCallBtn">
                      <i class="bi bi-telephone me-2"></i>Log Call
                    </button>
                    <button class="btn btn-outline-info" id="scheduleTaskBtn">
                      <i class="bi bi-calendar me-2"></i>Schedule Task
                    </button>
                    <button class="btn btn-outline-warning" id="convertToCustomerBtn">
                      <i class="bi bi-arrow-right me-2"></i>Convert to Customer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Communication History -->
          <div class="card mt-3">
            <div class="card-header">
              <ul class="nav nav-tabs card-header-tabs" id="activityTabs">
                <li class="nav-item">
                  <a class="nav-link active" href="#activityAll" data-bs-toggle="tab">All Activity</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#activityEmails" data-bs-toggle="tab">Emails</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#activityCalls" data-bs-toggle="tab">Calls</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#activityTasks" data-bs-toggle="tab">Tasks</a>
                </li>
              </ul>
            </div>
            <div class="card-body">
              <div class="tab-content">
                <div class="tab-pane fade show active" id="activityAll">
                  <ul class="list-group" id="activityTimeline">
                    <!-- Activity timeline will be loaded here -->
                  </ul>
                </div>
                <div class="tab-pane fade" id="activityEmails">
                  <ul class="list-group" id="emailsList">
                    <!-- Emails will be loaded here -->
                  </ul>
                </div>
                <div class="tab-pane fade" id="activityCalls">
                  <ul class="list-group" id="callsList">
                    <!-- Calls will be loaded here -->
                  </ul>
                </div>
                <div class="tab-pane fade" id="activityTasks">
                  <ul class="list-group" id="tasksList">
                    <!-- Tasks will be loaded here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="editLeadFromDetailsBtn">Edit Lead</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Send Email Modal -->
  <div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sendEmailModalLabel">Send Email</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="emailForm">
            <input type="hidden" id="emailLeadId">
            <div class="mb-3">
              <label for="emailTo" class="form-label">To</label>
              <input type="email" class="form-control" id="emailTo" readonly>
            </div>
            <div class="mb-3">
              <label for="emailTemplate" class="form-label">Select Template</label>
              <select class="form-select" id="emailTemplate">
                <option value="">No Template (Custom Email)</option>
                <option value="welcome_template">Welcome Email</option>
                <option value="follow_up_template">Follow-up Email</option>
                <option value="proposal_template">Proposal Email</option>
                <option value="meeting_template">Meeting Confirmation</option>
                <option value="discovery_template">Discovery Questions</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="emailSubject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="emailSubject" required>
            </div>
            <div class="mb-3">
              <label for="emailBody" class="form-label">Message</label>
              <textarea class="form-control" id="emailBody" rows="10" required></textarea>
            </div>
            <div class="mb-3">
              <label for="emailAttachment" class="form-label">Attachment (optional)</label>
              <input type="file" class="form-control" id="emailAttachment">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sendEmailSubmitBtn">Send Email</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Log Call Modal -->
  <div class="modal fade" id="logCallModal" tabindex="-1" aria-labelledby="logCallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logCallModalLabel">Log Call</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="callForm">
            <input type="hidden" id="callLeadId">
            <div class="mb-3">
              <label for="callContact" class="form-label">Contact</label>
              <input type="text" class="form-control" id="callContact" readonly>
            </div>
            <div class="mb-3">
              <label for="callPhone" class="form-label">Phone</label>
              <input type="text" class="form-control" id="callPhone" readonly>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="callDate" class="form-label">Date & Time</label>
                <input type="datetime-local" class="form-control" id="callDate" required>
              </div>
              <div class="col-md-6">
                <label for="callDuration" class="form-label">Duration (minutes)</label>
                <input type="number" class="form-control" id="callDuration" min="1" value="15">
              </div>
            </div>
            <div class="mb-3">
              <label for="callDirection" class="form-label">Direction</label>
              <select class="form-select" id="callDirection">
                <option value="Outbound">Outbound</option>
                <option value="Inbound">Inbound</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="callOutcome" class="form-label">Outcome</label>
              <select class="form-select" id="callOutcome" required>
                <option value="Spoke to Contact">Spoke to Contact</option>
                <option value="Left Message">Left Message</option>
                <option value="No Answer">No Answer</option>
                <option value="Busy/Call Back">Busy/Call Back</option>
                <option value="Wrong Number">Wrong Number</option>
                <option value="Not Interested">Not Interested</option>
                <option value="Interested">Interested</option>
                <option value="Meeting Scheduled">Meeting Scheduled</option>
              </select>
            </div>
            <div class="mb-3">
              <button type="button" class="btn btn-outline-info" id="openCallScriptsBtn">
                <i class="bi bi-file-text me-1"></i> Select Call Script
              </button>
            </div>
            <div class="mb-3">
              <label for="callNotes" class="form-label">Notes</label>
              <textarea class="form-control" id="callNotes" rows="5"></textarea>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="scheduleFollowUp">
              <label class="form-check-label" for="scheduleFollowUp">Schedule Follow-up Task</label>
            </div>
            <div class="mb-3 follow-up-fields d-none">
              <label for="followUpDate" class="form-label">Follow-up Date</label>
              <input type="date" class="form-control" id="followUpDate">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="makeCallBtn">Make Call</button>
          <button type="button" class="btn btn-primary" id="logCallSubmitBtn">Log Call</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Scripts Modal -->
  <div class="modal fade" id="callScriptsModal" tabindex="-1" aria-labelledby="callScriptsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="callScriptsModalLabel">BPO Call Scripts</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion" id="callScriptsAccordion">
            <!-- Introduction Script -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="introductionHeading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#introductionCollapse" aria-expanded="true" aria-controls="introductionCollapse">
                  Introduction Script
                </button>
              </h2>
              <div id="introductionCollapse" class="accordion-collapse collapse show" aria-labelledby="introductionHeading">
                <div class="accordion-body">
                  <p>"Hello, may I speak with [Contact Name]? This is [Your Name] from [Your Company]. We're a business process outsourcing company specializing in [specific services]. I'm calling because we've helped companies like yours to [specific benefit, e.g., reduce operational costs by 30%]. Do you have a few minutes to discuss how we might be able to help your business?"</p>
                  <button class="btn btn-sm btn-outline-primary copy-script" data-script="introduction">Copy Script</button>
                </div>
              </div>
            </div>

            <!-- Discovery Script -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="discoveryHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#discoveryCollapse" aria-expanded="false" aria-controls="discoveryCollapse">
                  Discovery Script
                </button>
              </h2>
              <div id="discoveryCollapse" class="accordion-collapse collapse" aria-labelledby="discoveryHeading">
                <div class="accordion-body">
                  <p>"Thanks for taking the time to chat with me. To understand how we might best assist you, could you tell me about your current [relevant process, e.g., customer service or back-office operations]? What are some of the challenges you're experiencing in this area? [Listen carefully] And how are these challenges affecting your business overall? [Listen for pain points] What would an ideal solution look like for your company?"</p>
                  <button class="btn btn-sm btn-outline-primary copy-script" data-script="discovery">Copy Script</button>
                </div>
              </div>
            </div>

            <!-- Service Overview Script -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="serviceHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#serviceCollapse" aria-expanded="false" aria-controls="serviceCollapse">
                  Service Overview Script
                </button>
              </h2>
              <div id="serviceCollapse" class="accordion-collapse collapse" aria-labelledby="serviceHeading">
                <div class="accordion-body">
                  <p>"Based on what you've shared, I believe our [specific service] would be an excellent fit for your needs. Here's how we typically help businesses like yours: [Briefly explain service]. Our clients typically see [specific results, e.g., 40% cost reduction, 25% increase in customer satisfaction]. We achieve this through [brief explanation of process]. How does this align with what you're looking for?"</p>
                  <button class="btn btn-sm btn-outline-primary copy-script" data-script="service">Copy Script</button>
                </div>
              </div>
            </div>

            <!-- Objection Handling Script -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="objectionHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#objectionCollapse" aria-expanded="false" aria-controls="objectionCollapse">
                  Objection Handling Script
                </button>
              </h2>
              <div id="objectionCollapse" class="accordion-collapse collapse" aria-labelledby="objectionHeading">
                <div class="accordion-body">
                  <p>"I understand your concerns about [specific objection]. Many of our current clients had similar concerns before partnering with us. Here's how we addressed this issue: [explain solution]. For example, [share brief success story]. Would it be helpful if I connected you with a reference client who had similar concerns?"</p>
                  <button class="btn btn-sm btn-outline-primary copy-script" data-script="objection">Copy Script</button>
                </div>
              </div>
            </div>

            <!-- Closing Script -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="closingHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#closingCollapse" aria-expanded="false" aria-controls="closingCollapse">
                  Closing Script
                </button>
              </h2>
              <div id="closingCollapse" class="accordion-collapse collapse" aria-labelledby="closingHeading">
                <div class="accordion-body">
                  <p>"Based on our conversation today, I'd like to propose next steps. I can prepare a detailed proposal outlining how our services can address your specific needs, including projected cost savings and implementation timeline. Would you be interested in reviewing this proposal? Great! I can have that ready for you by [specific date]. In the meantime, do you have any other questions I can answer for you?"</p>
                  <button class="btn btn-sm btn-outline-primary copy-script" data-script="closing">Copy Script</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="useScriptBtn">Use Selected Script</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Convert to Customer Modal -->
  <div class="modal fade" id="convertCustomerModal" tabindex="-1" aria-labelledby="convertCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="convertCustomerModalLabel">Convert Lead to Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="convertCustomerForm">
            <input type="hidden" id="convertLeadId">
            <div class="mb-3">
              <label for="convertCompanyName" class="form-label">Company Name</label>
              <input type="text" class="form-control" id="convertCompanyName" readonly>
            </div>
            <div class="mb-3">
              <label for="convertContractValue" class="form-label">Contract Value</label>
              <input type="text" class="form-control" id="convertContractValue" required>
            </div>
            <div class="mb-3">
              <label for="convertContractStart" class="form-label">Contract Start Date</label>
              <input type="date" class="form-control" id="convertContractStart" required>
            </div>
            <div class="mb-3">
              <label for="convertContractEnd" class="form-label">Contract End Date</label>
              <input type="date" class="form-control" id="convertContractEnd">
            </div>
            <div class="mb-3">
              <label for="convertAccountManager" class="form-label">Account Manager</label>
              <input type="text" class="form-control" id="convertAccountManager" required>
            </div>
            <div class="mb-3">
              <label for="convertBillingAddress" class="form-label">Billing Address</label>
              <textarea class="form-control" id="convertBillingAddress" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="convertBillingContact" class="form-label">Billing Contact</label>
              <input type="text" class="form-control" id="convertBillingContact">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="convertRemoveLead">
              <label class="form-check-label" for="convertRemoveLead">Remove lead after conversion</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="convertCustomerSubmitBtn">Convert to Customer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Task Modal -->
  <div class="modal fade" id="scheduleTaskModal" tabindex="-1" aria-labelledby="scheduleTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scheduleTaskModalLabel">Schedule Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="scheduleTaskForm">
            <input type="hidden" id="taskLeadId">
            <div class="mb-3">
              <label for="taskTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="taskTitle" required>
            </div>
            <div class="mb-3">
              <label for="taskDescription" class="form-label">Description</label>
              <textarea class="form-control" id="taskDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="taskDueDate" class="form-label">Due Date</label>
              <input type="date" class="form-control" id="taskDueDate" required>
            </div>
            <div class="mb-3">
              <label for="taskAssignedTo" class="form-label">Assigned To</label>
              <input type="text" class="form-control" id="taskAssignedTo" value="Admin" required>
            </div>
            <div class="mb-3">
              <label for="taskPriority" class="form-label">Priority</label>
              <select class="form-select" id="taskPriority">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="taskType" class="form-label">Task Type</label>
              <select class="form-select" id="taskType">
                <option value="Call">Call</option>
                <option value="Email">Email</option>
                <option value="Meeting">Meeting</option>
                <option value="Follow-up">Follow-up</option>
                <option value="Proposal">Proposal</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="scheduleTaskSubmitBtn">Schedule Task</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables for lead data
    let leadQualityData = {};
    let serviceInterestData = [];
    let industryTypesData = [];
    
    // Load leads
    function loadLeads() {
      fetch('/api/leads')
        .then(response => response.json())
        .then(data => {
          const leadsTable = document.getElementById('leadsTable');
          leadsTable.innerHTML = '';
          
          // For each lead, get quality information
          const qualityPromises = data.map(lead => 
            fetch(`/api/leads/${lead.id}/score`)
              .then(response => response.json())
              .then(quality => {
                leadQualityData[lead.id] = quality;
                return { lead, quality };
              })
          );
          
          Promise.all(qualityPromises)
            .then(leadsWithQuality => {
              leadsWithQuality.forEach(({ lead, quality }) => {
                const row = document.createElement('tr');
                
                // Display service interest as a comma-separated list
                let serviceInterestText = '';
                if (lead.serviceInterest && lead.serviceInterest.length > 0) {
                  serviceInterestText = lead.serviceInterest.join(', ');
                }
                
                // Get the appropriate color class for the status
                let statusColorClass = '';
                switch(lead.status) {
                  case 'New': statusColorClass = 'bg-info'; break;
                  case 'Contacted': statusColorClass = 'bg-primary'; break;
                  case 'Qualified': statusColorClass = 'bg-success'; break;
                  case 'Proposal': statusColorClass = 'bg-warning'; break;
                  case 'Negotiation': statusColorClass = 'bg-warning'; break;
                  case 'Closed': statusColorClass = 'bg-success'; break;
                  case 'Lost': statusColorClass = 'bg-danger'; break;
                  default: statusColorClass = 'bg-secondary';
                }
                
                // Get the appropriate color class for the quality
                let qualityColorClass = '';
                switch(quality.qualityRating) {
                  case 'Hot': qualityColorClass = 'bg-danger'; break;
                  case 'Warm': qualityColorClass = 'bg-warning'; break;
                  case 'Cold': qualityColorClass = 'bg-info'; break;
                  default: qualityColorClass = 'bg-secondary';
                }
                
                row.innerHTML = `
                  <td>${lead.company}</td>
                  <td>${lead.contact}</td>
                  <td>${lead.email}</td>
                  <td>${lead.phone}</td>
                  <td><span class="badge rounded-pill ${statusColorClass}">${lead.status}</span></td>
                  <td>${serviceInterestText || 'N/A'}</td>
                  <td><span class="badge rounded-pill ${qualityColorClass}">${quality.qualityRating} (${quality.score})</span></td>
                  <td>${lead.lastActivity || 'N/A'}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-info view-lead" data-id="${lead.id}">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary edit-lead" data-id="${lead.id}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-lead" data-id="${lead.id}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                `;
                leadsTable.appendChild(row);
              });
              
              // Add event listeners for view buttons
              document.querySelectorAll('.view-lead').forEach(button => {
                button.addEventListener('click', function() {
                  const leadId = this.getAttribute('data-id');
                  viewLeadDetails(leadId);
                });
              });
              
              // Add event listeners for edit buttons
              document.querySelectorAll('.edit-lead').forEach(button => {
                button.addEventListener('click', function() {
                  const leadId = this.getAttribute('data-id');
                  editLead(leadId);
                });
              });
              
              // Add event listeners for delete buttons
              document.querySelectorAll('.delete-lead').forEach(button => {
                button.addEventListener('click', function() {
                  const leadId = this.getAttribute('data-id');
                  deleteLead(leadId);
                });
              });
            });
        });
    }
    
    // Load service offerings
    function loadServiceOfferings() {
      fetch('/api/leads/services/offerings')
        .then(response => response.json())
        .then(data => {
          serviceInterestData = data;
          
          // Populate service interest dropdown for new lead
          const selectNew = document.getElementById('leadServiceInterest');
          selectNew.innerHTML = '';
          
          // Populate service interest dropdown for edit lead
          const selectEdit = document.getElementById('editLeadServiceInterest');
          selectEdit.innerHTML = '';
          
          data.forEach(category => {
            // Create optgroup for category
            const optgroupNew = document.createElement('optgroup');
            optgroupNew.label = category.category;
            
            const optgroupEdit = document.createElement('optgroup');
            optgroupEdit.label = category.category;
            
            // Add services as options
            category.services.forEach(service => {
              const optionNew = document.createElement('option');
              optionNew.value = service;
              optionNew.textContent = service;
              optgroupNew.appendChild(optionNew);
              
              const optionEdit = document.createElement('option');
              optionEdit.value = service;
              optionEdit.textContent = service;
              optgroupEdit.appendChild(optionEdit);
            });
            
            selectNew.appendChild(optgroupNew);
            selectEdit.appendChild(optgroupEdit);
          });
        });
    }
    
    // Load industry types
    function loadIndustryTypes() {
      fetch('/api/leads/industry/types')
        .then(response => response.json())
        .then(data => {
          industryTypesData = data;
          
          // Populate industry dropdown for new lead
          const selectNew = document.getElementById('leadIndustry');
          
          // Populate industry dropdown for edit lead
          const selectEdit = document.getElementById('editLeadIndustry');
          
          data.forEach(industry => {
            const optionNew = document.createElement('option');
            optionNew.value = industry;
            optionNew.textContent = industry;
            selectNew.appendChild(optionNew);
            
            const optionEdit = document.createElement('option');
            optionEdit.value = industry;
            optionEdit.textContent = industry;
            selectEdit.appendChild(optionEdit);
          });
        });
    }
    
    // View lead details
    function viewLeadDetails(id) {
      fetch(`/api/leads/${id}`)
        .then(response => response.json())
        .then(lead => {
          // Set lead details in the modal
          document.getElementById('detailLeadCompany').textContent = lead.company;
          document.getElementById('detailLeadContact').textContent = lead.contact;
          document.getElementById('detailLeadEmail').textContent = lead.email;
          document.getElementById('detailLeadPhone').textContent = lead.phone;
          document.getElementById('detailLeadIndustry').textContent = lead.industryType || 'N/A';
          document.getElementById('detailLeadCompanySize').textContent = lead.companySize || 'N/A';
          document.getElementById('detailLeadSource').textContent = lead.source || 'N/A';
          document.getElementById('detailLeadDecisionMaker').textContent = lead.decisionMaker ? 'Yes' : 'No';
          document.getElementById('detailLeadBudget').textContent = lead.budget || 'N/A';
          document.getElementById('detailLeadTimeline').textContent = lead.timeline || 'N/A';
          document.getElementById('detailLeadCreated').textContent = lead.createdAt || 'N/A';
          document.getElementById('detailLeadLastActivity').textContent = lead.lastActivity || 'N/A';
          document.getElementById('detailLeadPainPoints').textContent = lead.painPoints || 'None specified';
          document.getElementById('detailLeadRequirements').textContent = lead.requirements || 'None specified';
          document.getElementById('detailLeadNotes').textContent = lead.notes || 'No notes available';
          
          // Set service interest
          if (lead.serviceInterest && lead.serviceInterest.length > 0) {
            document.getElementById('detailLeadServiceInterest').textContent = lead.serviceInterest.join(', ');
          } else {
            document.getElementById('detailLeadServiceInterest').textContent = 'None specified';
          }
          
          // Set lead status with appropriate color
          const statusElement = document.getElementById('detailLeadStatus');
          statusElement.textContent = lead.status;
          
          // Reset all color classes
          statusElement.className = 'badge rounded-pill';
          
          // Add appropriate color class
          switch(lead.status) {
            case 'New': statusElement.classList.add('bg-info'); break;
            case 'Contacted': statusElement.classList.add('bg-primary'); break;
            case 'Qualified': statusElement.classList.add('bg-success'); break;
            case 'Proposal': statusElement.classList.add('bg-warning'); break;
            case 'Negotiation': statusElement.classList.add('bg-warning'); break;
            case 'Closed': statusElement.classList.add('bg-success'); break;
            case 'Lost': statusElement.classList.add('bg-danger'); break;
            default: statusElement.classList.add('bg-secondary');
          }
          
          // Get lead score
          fetch(`/api/leads/${id}/score`)
            .then(response => response.json())
            .then(score => {
              // Update score display
              document.getElementById('detailLeadScoreValue').textContent = score.score;
              document.getElementById('detailLeadScoreBar').style.width = `${score.score}%`;
              document.getElementById('detailLeadScoreBar').setAttribute('aria-valuenow', score.score);
              document.getElementById('detailLeadScoreBar').textContent = `${score.score}%`;
              
              // Set quality rating with appropriate color
              const qualityElement = document.getElementById('detailLeadQuality');
              qualityElement.textContent = score.qualityRating;
              
              // Reset all color classes
              qualityElement.className = 'badge rounded-pill';
              
              // Add appropriate color class
              switch(score.qualityRating) {
                case 'Hot': qualityElement.classList.add('bg-danger'); break;
                case 'Warm': qualityElement.classList.add('bg-warning'); break;
                case 'Cold': qualityElement.classList.add('bg-info'); break;
                default: qualityElement.classList.add('bg-secondary');
              }
              
              // Store the lead ID for communication actions
              document.getElementById('sendEmailBtn').setAttribute('data-id', lead.id);
              document.getElementById('logCallBtn').setAttribute('data-id', lead.id);
              document.getElementById('scheduleTaskBtn').setAttribute('data-id', lead.id);
              document.getElementById('convertToCustomerBtn').setAttribute('data-id', lead.id);
              document.getElementById('editLeadFromDetailsBtn').setAttribute('data-id', lead.id);
              
              // Show the modal
              const detailsModal = new bootstrap.Modal(document.getElementById('leadDetailsModal'));
              detailsModal.show();
              
              // Load activities
              loadLeadActivities(id);
            });
        });
    }
    
    // Load lead activities
    function loadLeadActivities(leadId) {
      fetch(`/api/leads/${leadId}/activities`)
        .then(response => response.json())
        .then(activities => {
          const timelineContainer = document.getElementById('activityTimeline');
          const emailsContainer = document.getElementById('emailsList');
          const callsContainer = document.getElementById('callsList');
          const tasksContainer = document.getElementById('tasksList');
          
          // Clear containers
          timelineContainer.innerHTML = '';
          emailsContainer.innerHTML = '';
          callsContainer.innerHTML = '';
          tasksContainer.innerHTML = '';
          
          if (activities.length === 0) {
            timelineContainer.innerHTML = '<li class="list-group-item">No activities recorded</li>';
            emailsContainer.innerHTML = '<li class="list-group-item">No emails recorded</li>';
            callsContainer.innerHTML = '<li class="list-group-item">No calls recorded</li>';
            tasksContainer.innerHTML = '<li class="list-group-item">No tasks recorded</li>';
            return;
          }
          
          // Filter activities by type
          const emails = activities.filter(activity => activity.type === 'email');
          const calls = activities.filter(activity => activity.type === 'call');
          const tasks = activities.filter(activity => activity.type === 'task');
          
          // Populate All Activities timeline
          activities.forEach(activity => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            
            let icon = '';
            let statusBadge = '';
            
            if (activity.type === 'email') {
              icon = '<i class="bi bi-envelope me-2 text-primary"></i>';
            } else if (activity.type === 'call') {
              icon = '<i class="bi bi-telephone me-2 text-success"></i>';
              statusBadge = activity.outcome ? 
                `<span class="badge bg-secondary float-end">${activity.outcome}</span>` : '';
            } else {
              icon = '<i class="bi bi-calendar me-2 text-info"></i>';
              statusBadge = activity.status ? 
                `<span class="badge bg-secondary float-end">${activity.status}</span>` : '';
            }
            
            listItem.innerHTML = `
              ${icon}<strong>${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}</strong> - ${activity.date} ${statusBadge}
              <p class="mb-0 ms-4">${activity.subject}</p>
              <p class="mb-0 ms-4 text-muted small">${activity.details}</p>
            `;
            
            timelineContainer.appendChild(listItem);
          });
          
          // Populate Emails list
          if (emails.length === 0) {
            emailsContainer.innerHTML = '<li class="list-group-item">No emails recorded</li>';
          } else {
            emails.forEach(email => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item';
              listItem.innerHTML = `
                <strong>${email.subject}</strong> - ${email.date}
                <p class="mb-0">${email.details}</p>
              `;
              emailsContainer.appendChild(listItem);
            });
          }
          
          // Populate Calls list
          if (calls.length === 0) {
            callsContainer.innerHTML = '<li class="list-group-item">No calls recorded</li>';
          } else {
            calls.forEach(call => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item';
              listItem.innerHTML = `
                <strong>${call.subject}</strong> - ${call.date}
                <span class="badge bg-secondary float-end">${call.outcome}</span>
                <p class="mb-0">${call.details}</p>
              `;
              callsContainer.appendChild(listItem);
            });
          }
          
          // Populate Tasks list
          if (tasks.length === 0) {
            tasksContainer.innerHTML = '<li class="list-group-item">No tasks recorded</li>';
          } else {
            tasks.forEach(task => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item';
              
              // Get appropriate color for status
              let statusColorClass = 'bg-secondary';
              if (task.status === 'Completed') statusColorClass = 'bg-success';
              else if (task.status === 'Pending') statusColorClass = 'bg-warning';
              
              listItem.innerHTML = `
                <strong>${task.subject}</strong> - Due: ${task.date}
                <span class="badge ${statusColorClass} float-end">${task.status}</span>
                <p class="mb-0">${task.details}</p>
              `;
              tasksContainer.appendChild(listItem);
            });
          }
        });
    }
    
    // Edit lead
    function editLead(id) {
      fetch(`/api/leads/${id}`)
        .then(response => response.json())
        .then(lead => {
          document.getElementById('editLeadId').value = lead.id;
          document.getElementById('editLeadCompany').value = lead.company;
          document.getElementById('editLeadContact').value = lead.contact;
          document.getElementById('editLeadEmail').value = lead.email;
          document.getElementById('editLeadPhone').value = lead.phone;
          document.getElementById('editLeadStatus').value = lead.status;
          document.getElementById('editLeadSource').value = lead.source;
          
          // Set BPO-specific fields
          if (lead.industryType) document.getElementById('editLeadIndustry').value = lead.industryType;
          if (lead.companySize) document.getElementById('editLeadCompanySize').value = lead.companySize;
          if (lead.budget) document.getElementById('editLeadBudget').value = lead.budget;
          if (lead.timeline) document.getElementById('editLeadTimeline').value = lead.timeline;
          
          document.getElementById('editLeadDecisionMaker').checked = lead.decisionMaker || false;
          document.getElementById('editLeadPainPoints').value = lead.painPoints || '';
          document.getElementById('editLeadRequirements').value = lead.requirements || '';
          document.getElementById('editLeadNotes').value = lead.notes || '';
          
          // Set service interest
          if (lead.serviceInterest && lead.serviceInterest.length > 0) {
            const select = document.getElementById('editLeadServiceInterest');
            for (let i = 0; i < select.options.length; i++) {
              if (lead.serviceInterest.includes(select.options[i].value)) {
                select.options[i].selected = true;
              }
            }
          }
          
          // Show the modal
          const editModal = new bootstrap.Modal(document.getElementById('editLeadModal'));
          editModal.show();
        });
    }
    
    // Delete lead
    function deleteLead(id) {
      if (confirm('Are you sure you want to delete this lead?')) {
        fetch(`/api/leads/${id}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(() => {
            loadLeads();
          });
      }
    }
    
    // Send email to lead
    function sendEmail(leadId) {
      fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(lead => {
          document.getElementById('emailLeadId').value = lead.id;
          document.getElementById('emailTo').value = lead.email;
          
          // Show the modal
          const emailModal = new bootstrap.Modal(document.getElementById('sendEmailModal'));
          emailModal.show();
        });
    }
    
    // Log call to lead
    function logCall(leadId) {
      fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(lead => {
          document.getElementById('callLeadId').value = lead.id;
          document.getElementById('callContact').value = lead.contact;
          document.getElementById('callPhone').value = lead.phone;
          
          // Set current date and time
          const now = new Date();
          now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          document.getElementById('callDate').value = now.toISOString().slice(0, 16);
          
          // Show the modal
          const callModal = new bootstrap.Modal(document.getElementById('logCallModal'));
          callModal.show();
        });
    }
    
    // Schedule task for lead
    function scheduleTask(leadId) {
      fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(lead => {
          document.getElementById('taskLeadId').value = lead.id;
          
          // Set default task title based on lead
          document.getElementById('taskTitle').value = `Follow up with ${lead.company}`;
          
          // Set tomorrow as the default due date
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
          
          // Show the modal
          const taskModal = new bootstrap.Modal(document.getElementById('scheduleTaskModal'));
          taskModal.show();
        });
    }
    
    // Convert lead to customer
    function convertToCustomer(leadId) {
      fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(lead => {
          document.getElementById('convertLeadId').value = lead.id;
          document.getElementById('convertCompanyName').value = lead.company;
          
          // Set today as default contract start date
          const today = new Date();
          document.getElementById('convertContractStart').value = today.toISOString().split('T')[0];
          
          // Set contract end date one year from today as default
          const oneYearLater = new Date();
          oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
          document.getElementById('convertContractEnd').value = oneYearLater.toISOString().split('T')[0];
          
          // Set default billing contact to lead contact
          document.getElementById('convertBillingContact').value = lead.contact;
          
          // Show the modal
          const convertModal = new bootstrap.Modal(document.getElementById('convertCustomerModal'));
          convertModal.show();
        });
    }
    
    // Handle email template selection
    function handleEmailTemplateSelection() {
      const template = document.getElementById('emailTemplate').value;
      const leadId = document.getElementById('emailLeadId').value;
      
      if (!template) return;
      
      // Fetch lead data
      fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(lead => {
          let subject = '';
          let body = '';
          
          // Set subject and body based on template
          switch(template) {
            case 'welcome_template':
              subject = `Welcome to Our BPO Services - ${lead.company}`;
              body = `Dear ${lead.contact},\n\nThank you for choosing our BPO services. We're excited to work with you and help optimize your business processes.\n\nYour dedicated account manager is [ACCOUNT_MANAGER_NAME], who can be reached at [ACCOUNT_MANAGER_EMAIL] or by phone at [ACCOUNT_MANAGER_PHONE].\n\nOur team will be in touch shortly to schedule an onboarding call to discuss your specific requirements and next steps.\n\nBest regards,\nYour Company Name`;
              break;
            case 'follow_up_template':
              subject = `Follow-up from Our Recent Conversation - ${lead.company}`;
              body = `Dear ${lead.contact},\n\nI hope this email finds you well. I wanted to follow up on our recent conversation regarding your BPO service requirements.\n\n[INSERT CUSTOM MESSAGE HERE]\n\nIf you have any questions or would like to schedule another call, please don't hesitate to contact me.\n\nBest regards,\nYour Name\nYour Position\nYour Company`;
              break;
            case 'proposal_template':
              subject = `Service Proposal for ${lead.company}`;
              body = `Dear ${lead.contact},\n\nThank you for the opportunity to present our BPO services. Based on our discussion, we're pleased to provide the following proposal tailored to your specific needs.\n\nProposed Services:\n- [SERVICE 1]\n- [SERVICE 2]\n- [SERVICE 3]\n\nPricing Details:\n[PRICING DETAILS]\n\nThe proposed timeline for implementation is [TIMELINE].\n\nThis proposal is valid until [DATE]. We look forward to the opportunity to work with you.\n\nBest regards,\nYour Name\nYour Position\nYour Company`;
              break;
            case 'meeting_template':
              subject = `Meeting Confirmation - ${lead.company}`;
              body = `Dear ${lead.contact},\n\nI'm writing to confirm our upcoming meeting on [DATE] at [TIME]. During this call, we'll discuss your BPO requirements in more detail and explore how our services can address your specific needs.\n\nIf you need to reschedule or have any questions before our meeting, please don't hesitate to contact me.\n\nLooking forward to our conversation.\n\nBest regards,\nYour Name\nYour Position\nYour Company`;
              break;
            case 'discovery_template':
              subject = `BPO Service Assessment Questions - ${lead.company}`;
              body = `Dear ${lead.contact},\n\nTo help us better understand your BPO needs and prepare for our upcoming discussions, we've prepared a few questions we'd appreciate you answering:\n\n1. What specific business processes are you looking to outsource?\n\n2. What are your main goals for implementing BPO services? (e.g., cost reduction, improved efficiency, access to specialized skills)\n\n3. How many employees are currently handling these processes internally?\n\n4. What technologies or systems are you currently using for these processes?\n\n5. What timeline are you considering for implementation?\n\nYour responses will help us prepare a more tailored discussion and potential solution for your needs.\n\nBest regards,\nYour Name\nYour Position\nYour Company`;
              break;
          }
          
          document.getElementById('emailSubject').value = subject;
          document.getElementById('emailBody').value = body;
        });
    }
    
    // Document ready
    document.addEventListener('DOMContentLoaded', function() {
      // Load leads, service offerings, and industry types
      loadLeads();
      loadServiceOfferings();
      loadIndustryTypes();
      
      // Add new lead
      document.getElementById('saveLeadBtn').addEventListener('click', function() {
        // Get selected service interests
        const serviceSelect = document.getElementById('leadServiceInterest');
        const selectedServices = Array.from(serviceSelect.selectedOptions).map(option => option.value);
        
        const leadData = {
          company: document.getElementById('leadCompany').value,
          contact: document.getElementById('leadContact').value,
          email: document.getElementById('leadEmail').value,
          phone: document.getElementById('leadPhone').value,
          status: document.getElementById('leadStatus').value,
          source: document.getElementById('leadSource').value,
          notes: document.getElementById('leadNotes').value,
          // BPO specific fields
          serviceInterest: selectedServices,
          industryType: document.getElementById('leadIndustry').value,
          companySize: document.getElementById('leadCompanySize').value,
          budget: document.getElementById('leadBudget').value,
          timeline: document.getElementById('leadTimeline').value,
          decisionMaker: document.getElementById('leadDecisionMaker').checked,
          painPoints: document.getElementById('leadPainPoints').value,
          requirements: document.getElementById('leadRequirements').value
        };
        
        fetch('/api/leads', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(leadData)
        })
          .then(response => response.json())
          .then(() => {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addLeadModal'));
            modal.hide();
            
            // Clear the form
            document.getElementById('addLeadForm').reset();
            
            // Reload leads
            loadLeads();
          });
      });
      
      // Update lead
      document.getElementById('updateLeadBtn').addEventListener('click', function() {
        const leadId = document.getElementById('editLeadId').value;
        
        // Get selected service interests
        const serviceSelect = document.getElementById('editLeadServiceInterest');
        const selectedServices = Array.from(serviceSelect.selectedOptions).map(option => option.value);
        
        const leadData = {
          company: document.getElementById('editLeadCompany').value,
          contact: document.getElementById('editLeadContact').value,
          email: document.getElementById('editLeadEmail').value,
          phone: document.getElementById('editLeadPhone').value,
          status: document.getElementById('editLeadStatus').value,
          source: document.getElementById('editLeadSource').value,
          notes: document.getElementById('editLeadNotes').value,
          // BPO specific fields
          serviceInterest: selectedServices,
          industryType: document.getElementById('editLeadIndustry').value,
          companySize: document.getElementById('editLeadCompanySize').value,
          budget: document.getElementById('editLeadBudget').value,
          timeline: document.getElementById('editLeadTimeline').value,
          decisionMaker: document.getElementById('editLeadDecisionMaker').checked,
          painPoints: document.getElementById('editLeadPainPoints').value,
          requirements: document.getElementById('editLeadRequirements').value
        };
        
        fetch(`/api/leads/${leadId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(leadData)
        })
          .then(response => response.json())
          .then(() => {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editLeadModal'));
            modal.hide();
            
            // Reload leads
            loadLeads();
          });
      });
      
      // Email template selection
      document.getElementById('emailTemplate').addEventListener('change', handleEmailTemplateSelection);
      
      // Send Email Button Event
      document.getElementById('sendEmailBtn').addEventListener('click', function() {
        const leadId = this.getAttribute('data-id');
        sendEmail(leadId);
      });
      
      // Log Call Button Event
      document.getElementById('logCallBtn').addEventListener('click', function() {
        const leadId = this.getAttribute('data-id');
        logCall(leadId);
      });
      
      // Schedule Task Button Event
      document.getElementById('scheduleTaskBtn').addEventListener('click', function() {
        const leadId = this.getAttribute('data-id');
        scheduleTask(leadId);
      });
      
      // Convert to Customer Button Event
      document.getElementById('convertToCustomerBtn').addEventListener('click', function() {
        const leadId = this.getAttribute('data-id');
        convertToCustomer(leadId);
      });
      
      // Edit Lead from Details Button Event
      document.getElementById('editLeadFromDetailsBtn').addEventListener('click', function() {
        const leadId = this.getAttribute('data-id');
        
        // Close the details modal
        const detailsModal = bootstrap.Modal.getInstance(document.getElementById('leadDetailsModal'));
        detailsModal.hide();
        
        // Open the edit modal
        editLead(leadId);
      });
      
      // Schedule Follow-up checkbox
      document.getElementById('scheduleFollowUp').addEventListener('change', function() {
        const followUpFields = document.querySelector('.follow-up-fields');
        if (this.checked) {
          followUpFields.classList.remove('d-none');
        } else {
          followUpFields.classList.add('d-none');
        }
      });
      
      // Open call scripts modal
      document.getElementById('openCallScriptsBtn').addEventListener('click', function() {
        const callScriptsModal = new bootstrap.Modal(document.getElementById('callScriptsModal'));
        callScriptsModal.show();
      });
      
      // Copy script to clipboard
      document.querySelectorAll('.copy-script').forEach(button => {
        button.addEventListener('click', function() {
          const scriptType = this.getAttribute('data-script');
          const scriptText = this.previousElementSibling.textContent;
          
          // Copy to clipboard
          navigator.clipboard.writeText(scriptText).then(() => {
            // Change button text temporarily
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => {
              this.textContent = originalText;
            }, 2000);
          });
        });
      });
      
      // Use selected script button
      document.getElementById('useScriptBtn').addEventListener('click', function() {
        // Find the expanded accordion item and get its script
        const expandedItem = document.querySelector('.accordion-collapse.show');
        if (expandedItem) {
          const scriptText = expandedItem.querySelector('p').textContent;
          document.getElementById('callNotes').value = scriptText;
          
          // Close the script modal
          const scriptModal = bootstrap.Modal.getInstance(document.getElementById('callScriptsModal'));
          scriptModal.hide();
        }
      });
      
      // Send Email Submit
      document.getElementById('sendEmailSubmitBtn').addEventListener('click', function() {
        const emailData = {
          leadId: document.getElementById('emailLeadId').value,
          to: document.getElementById('emailTo').value,
          subject: document.getElementById('emailSubject').value,
          body: document.getElementById('emailBody').value,
          template: document.getElementById('emailTemplate').value
        };
        
        // For demo, we just simulate email sending
        console.log('Email Data:', emailData);
        
        // Normally we would call the email API endpoint
        /*
        fetch('/api/emails/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(emailData)
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Email sent successfully!');
            } else {
              alert('Failed to send email: ' + data.error);
            }
          });
        */
        
        // For demo purposes, just show success
        alert('Email sent successfully!');
        
        // Close the email modal
        const emailModal = bootstrap.Modal.getInstance(document.getElementById('sendEmailModal'));
        emailModal.hide();
        
        // Reload leads
        loadLeads();
      });
      
      // Log Call Submit
      document.getElementById('logCallSubmitBtn').addEventListener('click', function() {
        const callData = {
          leadId: document.getElementById('callLeadId').value,
          contact: document.getElementById('callContact').value,
          phone: document.getElementById('callPhone').value,
          date: document.getElementById('callDate').value,
          duration: document.getElementById('callDuration').value,
          direction: document.getElementById('callDirection').value,
          outcome: document.getElementById('callOutcome').value,
          notes: document.getElementById('callNotes').value
        };
        
        // For demo, we just simulate call logging
        console.log('Call Data:', callData);
        
        // Check if follow-up task should be scheduled
        if (document.getElementById('scheduleFollowUp').checked) {
          const taskData = {
            title: `Follow up with ${callData.contact}`,
            description: `Follow up on call from ${new Date().toISOString().split('T')[0]}. Notes: ${callData.notes}`,
            dueDate: document.getElementById('followUpDate').value,
            assignedTo: 'Admin',
            status: 'Pending',
            relatedTo: 'lead',
            relatedId: callData.leadId
          };
          
          // For demo, we just simulate task creation
          console.log('Task Data:', taskData);
          
          // Normally we would call the task API endpoint
          /*
          fetch('/api/tasks', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
          })
            .then(response => response.json())
            .then(data => {
              console.log('Task created:', data);
            });
          */
        }
        
        // For demo purposes, just show success
        alert('Call logged successfully!' + (document.getElementById('scheduleFollowUp').checked ? ' Follow-up task scheduled.' : ''));
        
        // Close the call modal
        const callModal = bootstrap.Modal.getInstance(document.getElementById('logCallModal'));
        callModal.hide();
        
        // Close the lead details modal if it's open
        const detailsModal = document.getElementById('leadDetailsModal');
        if (detailsModal.classList.contains('show')) {
          bootstrap.Modal.getInstance(detailsModal).hide();
        }
        
        // Reload leads
        loadLeads();
      });
      
      // Make Call Button
      document.getElementById('makeCallBtn').addEventListener('click', function() {
        const phoneNumber = document.getElementById('callPhone').value;
        
        // For demo purposes, we'll just show an alert
        alert(`Initiating call to ${phoneNumber}...\n\nIn a production environment, this would connect to your phone system (e.g., Twilio) to place the actual call.`);
        
        // In a real implementation, we would call the API to initiate a call
        /*
        fetch('/api/calls/make', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phone: phoneNumber,
            message: "Hello, this is a call from BPO CRM. Our representative will be with you shortly.",
            relatedTo: 'lead',
            relatedId: document.getElementById('callLeadId').value,
            contactName: document.getElementById('callContact').value
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Call initiated successfully!');
            } else {
              alert('Failed to initiate call: ' + data.error);
            }
          });
        */
      });
      
      // Schedule Task Submit
      document.getElementById('scheduleTaskSubmitBtn').addEventListener('click', function() {
        const taskData = {
          title: document.getElementById('taskTitle').value,
          description: document.getElementById('taskDescription').value,
          dueDate: document.getElementById('taskDueDate').value,
          assignedTo: document.getElementById('taskAssignedTo').value,
          status: 'Pending',
          relatedTo: 'lead',
          relatedId: document.getElementById('taskLeadId').value,
          priority: document.getElementById('taskPriority').value,
          type: document.getElementById('taskType').value
        };
        
        // For demo, we just simulate task creation
        console.log('Task Data:', taskData);
        
        // Normally we would call the task API endpoint
        /*
        fetch('/api/tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        })
          .then(response => response.json())
          .then(data => {
            console.log('Task created:', data);
          });
        */
        
        // For demo purposes, just show success
        alert('Task scheduled successfully!');
        
        // Close the task modal
        const taskModal = bootstrap.Modal.getInstance(document.getElementById('scheduleTaskModal'));
        taskModal.hide();
        
        // Close the lead details modal if it's open
        const detailsModal = document.getElementById('leadDetailsModal');
        if (detailsModal.classList.contains('show')) {
          bootstrap.Modal.getInstance(detailsModal).hide();
        }
        
        // Reload leads
        loadLeads();
      });
      
      // Convert to Customer Submit
      document.getElementById('convertCustomerSubmitBtn').addEventListener('click', function() {
        const convertData = {
          contractValue: document.getElementById('convertContractValue').value,
          contractStart: document.getElementById('convertContractStart').value,
          contractEnd: document.getElementById('convertContractEnd').value,
          accountManager: document.getElementById('convertAccountManager').value,
          billingAddress: document.getElementById('convertBillingAddress').value,
          billingContact: document.getElementById('convertBillingContact').value,
          removeLead: document.getElementById('convertRemoveLead').checked
        };
        
        const leadId = document.getElementById('convertLeadId').value;
        
        // For demo, we just simulate conversion
        console.log('Convert Data:', convertData);
        
        // Normally we would call the conversion API endpoint
        /*
        fetch(`/api/leads/${leadId}/convert`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(convertData)
        })
          .then(response => response.json())
          .then(data => {
            console.log('Conversion result:', data);
          });
        */
        
        // For demo purposes, just show success
        alert('Lead converted to customer successfully!');
        
        // Close the convert modal
        const convertModal = bootstrap.Modal.getInstance(document.getElementById('convertCustomerModal'));
        convertModal.hide();
        
        // Close the lead details modal if it's open
        const detailsModal = document.getElementById('leadDetailsModal');
        if (detailsModal.classList.contains('show')) {
          bootstrap.Modal.getInstance(detailsModal).hide();
        }
        
        // Reload leads
        loadLeads();
      });
      
      // Filter functionality
      document.getElementById('searchLead').addEventListener('keyup', function() {
        loadLeads(); // In a real implementation, we would filter the data client-side or make a filtered API call
      });
      
      document.getElementById('statusFilter').addEventListener('change', function() {
        loadLeads(); // In a real implementation, we would filter the data client-side or make a filtered API call
      });
      
      document.getElementById('sourceFilter').addEventListener('change', function() {
        loadLeads(); // In a real implementation, we would filter the data client-side or make a filtered API call
      });
      
      document.getElementById('serviceFilter').addEventListener('change', function() {
        loadLeads(); // In a real implementation, we would filter the data client-side or make a filtered API call
      });
      
      document.getElementById('qualityFilter').addEventListener('change', function() {
        loadLeads(); // In a real implementation, we would filter the data client-side or make a filtered API call
      });
    });
  </script>
</body>
</html>